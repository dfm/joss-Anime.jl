<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>Anime: Atmospheric and Instrument Models in the Measurement Equation</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
</head>
<body>
<header id="title-block-header">
<h1 class="title">Anime: Atmospheric and Instrument Models in the Measurement Equation</h1>
<p class="date">2 Nov 2023</p>
</header>
<h1 id="summary">Summary</h1>
<p><code>Anime</code> is an instrument modelling package for radio interferometry, specifically for modelling very-long-baseline-interferometry (VLBI) observations, written in the Julia<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> programming language <span class="citation" data-cites="Bezanson2015">[@Bezanson2015]</span>. It aims to model from first principles the effects of Earth’s atmosphere and the electronic and mechanical properties of antennas that significantly affect VLBI observations at millimetre (mm) and sub-mm wavelengths, ensuring that the models are statistically consistent with empirical data. It provides realistic instrument models to calibrate, simulate, and produce images of mm-VLBI data sets. It also aims to provide efficient handling of and seamless conversion routines between popular formats used to represent VLBI observations and their metadata.</p>
<h1 id="statement-of-need">Statement of need</h1>
<p>The Event Horizon Telescope (EHT) is a global VLBI network that has produced the first ever high resolution images of supermassive black holes at the centres of galaxies <span class="citation" data-cites="M87PaperI SgrAPaperI">[@M87PaperI; @SgrAPaperI]</span>. The EHT Collaboration has developed new methods to model, calibrate, and analyse data from sparse, heterogeneous VLBI arrays to enable the reconstruction of black hole images at such high resolutions and observing frequencies. The success of these methods relies on accurately modelling the astrophysical source of interest and the propagation path effects that modify the signal on its way to the recorder.</p>
<p>In radio interferometry parlance, calibration is the process of minimizing atmospheric and instrumental effects and imaging is the process of deriving the sky brightness distribution from calibrated data. The boundary between calibration and imaging is variable and one of convenience, since these two tasks can be performed alternately and iteratively, or simultaneously, depending on the scientific problem under investigation and software capability. Within the EHT, the raw data are calibrated using two calibration pipelines, <code>EHT-HOPS</code> <span class="citation" data-cites="Blackburn2019">[@Blackburn2019]</span> and <code>rPICARD</code> <span class="citation" data-cites="Janssen2019">[@Janssen2019]</span>. The calibrated data are then used by software such as <code>eht-imaging</code> <span class="citation" data-cites="Chael2018">[@Chael2018]</span> and <code>Comrade</code> <span class="citation" data-cites="Tiede2022">[@Tiede2022]</span>, which attempt to reconstruct the sky brightness distribution while accounting for residual calibration errors by modelling source and instrumental properties.</p>
<p>Instrument models are also used to generate realistic synthetic data for testing new calibration and imaging methods and to quantify the modelling parameters to be used for real data analysis. <code>MEQSv2</code> <span class="citation" data-cites="Natarajan2022">[@Natarajan2022]</span> is a synthetic data generation software for VLBI that introduces physically motivated signal corruptions to radio observations and is used by the end-to-end simulation and calibration pipeline <code>SYMBA</code> <span class="citation" data-cites="Roelofs2020">[@Roelofs2020]</span>. <code>ngehtsim</code> <span class="citation" data-cites="Pesceinprep">[@Pesceinprep]</span>, which is based on <code>eht-imaging</code>, models effects such as local weather effects, telescope properties, and emulation of fringe-finding to generate synthetic data for the next-generation EHT (ngEHT). While <code>MEQSv2</code> and <code>SYMBA</code> have more complex modelling capabilities it is a monolithic piece of software and are considerably slow. <code>ngehtsim</code> generates synthetic data faster but does not include some complex effects introduced by <code>MEQSv2</code>.</p>
<p><code>Anime</code> aims to provide the speed and flexibility of <code>ngehtsim</code> with the complex modelling capabilities of <code>MEQSv2</code> by taking advantage of the features offered by the Julia programming language. Julia combines the performance of compiled languages such as C with the ease of development found in languages such as Python. Julia’s automatic differentiation support also makes the instrument models provided by <code>Anime</code> inherently differentiable and peform parameter space exploration faster. Finally, <code>Comrade</code> is written in Julia and can import the instrument models from <code>Anime</code> natively.</p>
<p><code>Anime</code> includes models for the troposphere, the lowest layer of Earth’s atmosphere, which significantly affects signal propagation at 230 GHz. It models the instrumental contribution to signal polarization to capture the leakage of polarized signals between orthogonal feeds. It also includes models for telescope mispointing, complex-valued (amplitude and phase) bandpass effects that vary over the observing bandwidth, complex-valued time-variable receiver gains, and noise contributions from the atmosphere at the observing frequencies.</p>
<p>Synthetic data generation capabilities are built into <code>Anime</code>, with support for popular data storage formats in VLBI. The instrument models are stored in HDF5 format that can be read by any calibration or simulation software with HDF5 support. Metadata are obtained from UVFITS corresponding to real data and the instrument models are applied to source coherency using the Radio Interferometer Measurement Equation (RIME) <span class="citation" data-cites="HBS1996">[@HBS1996]</span>. The RIME expresses the relationship between true and measured <em>visibilities</em>, complex-valued quantities obtained by correlating the voltage patterns observed at two different locations, by casting them into a linear algebraic formalism that describes how the propagation path effects modify the signal. In the 2 x 2 <em>Jones matrix</em> formalism <span class="citation" data-cites="OMS2011">[@OMS2011]</span> that <code>Anime</code> implements, the generic RIME can be written as</p>
<p><br /><span class="math display"><strong>V</strong><sub><em>p</em><em>q</em></sub> = <em>G</em><sub><em>p</em></sub>(∑<sub><em>s</em></sub><em>E</em><sub><em>s</em><em>p</em></sub> <strong>X</strong><sub><em>s</em><em>p</em><em>q</em></sub> <em>E</em><sub><em>s</em><em>q</em></sub><sup><em>H</em></sup>)<em>G</em><sub><em>q</em></sub><sup><em>H</em></sup>,</span><br /></p>
<p>where <span class="math inline"><strong>X</strong><sub><em>s</em><em>p</em><em>q</em></sub></span> is the source coherency that will be observed in the absence of corrupting effects, <span class="math inline"><em>E</em><sub><em>s</em><em>p</em></sub></span> and <span class="math inline"><em>G</em><sub><em>p</em></sub></span> are complex-valued matrices describing various propagation path effects and <span class="math inline"><strong>V</strong><sub><em>p</em><em>q</em></sub></span> are the measured visibilities corresponding to the baseline formed by stations <span class="math inline"><em>p</em></span> and <span class="math inline"><em>q</em></span>.</p>
<h1 id="code-structure">Code structure</h1>
<p>Figure 1 shows the components of <code>Anime</code>. VLBI data and metadata are loaded from disk to a Structure of Arrays (SoA) data structure. The instrument modelling functions interface with this structure and output the gain tables in HDF5 format. The functionality within the dashed lines is optional if <code>Anime</code> is used only for computing gain tables for calibration.</p>
<figure>
<img src="components.png" alt="" /><figcaption>caption</figcaption>
</figure>
<p><code>Anime</code> can be run in one of two modes: modular and pipeline. In modular mode, it can be imported like any other Julia package and instrument models are computed by calling the relevant functions. The routines to read/write/convert between storage formats and diagnostic plotting tools can also be called individually. In pipeline mode, little to no user interaction is required to generate a series of instrument models based on observation settings read from existing metadata, create new data sets from scratch and apply the instrument models to data. These data can be stored in both the CASA Measurement Set (MS) format<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> and the legacy UVFITS format commonly used within the EHT. All observation settings for running <code>Anime</code> in this mode can be provided in a <code>YAML</code> configuration file. The following example shows how to generate synthetic visibilities (Figure 2) from scratch using a sample <code>YAML</code> configuration file included with the source code.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode julia"><code class="sourceCode julia"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true"></a><span class="kw">using</span> YAML</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true"></a><span class="kw">using</span> Anime</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true"></a><span class="co"># load YAML file with observation parameters </span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true"></a>y <span class="op">=</span> YAML.load_file(config<span class="op">,</span> dicttype<span class="op">=</span><span class="dt">Dict</span>{<span class="dt">String</span><span class="op">,</span><span class="dt">Any</span>})</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true"></a>h5file <span class="op">=</span> <span class="st">&quot;models.h5&quot;</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true"></a><span class="co"># Generate MS from existing UVFITS</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true"></a>msfromuvfits(y[<span class="st">&quot;uvfits&quot;</span>]<span class="op">,</span> y[<span class="st">&quot;msname&quot;</span>]<span class="op">,</span> y[<span class="st">&quot;mode&quot;</span>])</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true"></a><span class="co"># compute source coherency</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true"></a>run_wsclean(y[<span class="st">&quot;msname&quot;</span>]<span class="op">,</span> y[<span class="st">&quot;skymodel&quot;</span>]<span class="op">,</span> y[<span class="st">&quot;polarized&quot;</span>]<span class="op">,</span> y[<span class="st">&quot;channelgroups&quot;</span>]<span class="op">,</span> y[<span class="st">&quot;osfactor&quot;</span>])</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true"></a><span class="co"># load data and observation parameters into Observation struct</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true"></a>obs <span class="op">=</span> loadms(y[<span class="st">&quot;msname&quot;</span>]<span class="op">,</span> y[<span class="st">&quot;stations&quot;</span>]<span class="op">,</span> <span class="dt">Int</span>(y[<span class="st">&quot;corruptseed&quot;</span>])<span class="op">,</span> <span class="dt">Int</span>(y[<span class="st">&quot;troposphere&quot;</span>][<span class="st">&quot;tropseed&quot;</span>])<span class="op">,</span> y[<span class="st">&quot;troposphere&quot;</span>][<span class="st">&quot;wetonly&quot;</span>]<span class="op">,</span> y[<span class="st">&quot;correff&quot;</span>]<span class="op">,</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true"></a>y[<span class="st">&quot;troposphere&quot;</span>][<span class="st">&quot;attenuate&quot;</span>]<span class="op">,</span> y[<span class="st">&quot;troposphere&quot;</span>][<span class="st">&quot;skynoise&quot;</span>]<span class="op">,</span> y[<span class="st">&quot;troposphere&quot;</span>][<span class="st">&quot;meandelays&quot;</span>]<span class="op">,</span> y[<span class="st">&quot;troposphere&quot;</span>][<span class="st">&quot;turbulence&quot;</span>]<span class="op">,</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true"></a>y[<span class="st">&quot;instrumentalpolarization&quot;</span>][<span class="st">&quot;visibilityframe&quot;</span>]<span class="op">,</span> y[<span class="st">&quot;instrumentalpolarization&quot;</span>][<span class="st">&quot;mode&quot;</span>]<span class="op">,</span> y[<span class="st">&quot;pointing&quot;</span>][<span class="st">&quot;interval&quot;</span>]<span class="op">,</span> y[<span class="st">&quot;pointing&quot;</span>][<span class="st">&quot;scale&quot;</span>]<span class="op">,</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true"></a>y[<span class="st">&quot;pointing&quot;</span>][<span class="st">&quot;mode&quot;</span>]<span class="op">,</span> y[<span class="st">&quot;stationgains&quot;</span>][<span class="st">&quot;mode&quot;</span>]<span class="op">,</span> y[<span class="st">&quot;bandpass&quot;</span>][<span class="st">&quot;bandpassfile&quot;</span>]<span class="op">,</span> delim<span class="op">=</span><span class="st">&quot;,&quot;</span><span class="op">,</span> ignorerepeated<span class="op">=</span><span class="ex">false</span>)</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true"></a><span class="co"># compute instrument models</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true"></a>troposphere<span class="op">!</span>(obs<span class="op">,</span> h5file)</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true"></a>instrumentalpolarization<span class="op">!</span>(obs<span class="op">,</span> h5file<span class="op">=</span>h5file)</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true"></a>pointing<span class="op">!</span>(obs<span class="op">,</span> h5file<span class="op">=</span>h5file)</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true"></a>stationgains<span class="op">!</span>(obs<span class="op">,</span> h5file<span class="op">=</span>h5file)</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true"></a>bandpass<span class="op">!</span>(obs<span class="op">,</span> h5file<span class="op">=</span>h5file)</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true"></a>thermalnoise<span class="op">!</span>(obs<span class="op">,</span> h5file<span class="op">=</span>h5file)</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true"></a><span class="co"># write changes to MS and convert to UVFITS</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true"></a>postprocessms(obs<span class="op">,</span> h5file<span class="op">=</span>h5file)</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true"></a>mstouvfits(y[<span class="st">&quot;msname&quot;</span>]<span class="op">,</span> <span class="st">&quot;test.uvfits&quot;</span><span class="op">,</span> <span class="st">&quot;corrected&quot;</span>)</span></code></pre></div>
<figure>
<img src="visplot.png" alt="" /><figcaption>caption</figcaption>
</figure>
<p><strong>Change the above image to one with all effects included</strong></p>
<h1 id="similar-packages">Similar Packages</h1>
<ul>
<li><code>MEQSv2</code> <span class="citation" data-cites="Natarajan2022">[@Natarajan2022]</span>: A synthetic data generation package for VLBI written in Python. It was the first VLBI simulator to include complex mm-wave observation effects used in the EHT and can compute most instrument models found in <code>Anime</code>.</li>
<li><code>SYMBA</code> <span class="citation" data-cites="Roelofs2020">[@Roelofs2020]</span>: An e-nd-to-end synthetic data generation pipeline that uses <code>MEQSv2</code> to generate synthetic data and calibrates them with <code>rPICARD</code>, introducing residual calibration effects, that closely match the properties of real EHT data.</li>
<li><code>ngehtsim</code> <span class="citation" data-cites="Pesceinprep">[@Pesceinprep]</span>: A fast and flexible (sub)mm VLBI synthetic data generator for the EHT and ngEHT based on <code>eht-imaging</code>, adding capabilities such as simulation of local weather effects and fringe-finding residuals.</li>
</ul>
<h1 id="acknowledgements">Acknowledgements</h1>
<p>This work was supported by MSIP2…</p>
<section class="footnotes" role="doc-endnotes">
<hr />
<ol>
<li id="fn1" role="doc-endnote"><p>https://julialang.org<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2" role="doc-endnote"><p>https://casa.nrao.edu/Memos/229.html<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>
</body>
</html>
